(function(c){c.flexselect=function(a,b){this.init(a,b)};c.extend(c.flexselect.prototype,{settings:{allowMismatch:false,selectedClass:"flexselect_selected",dropdownClass:"flexselect_dropdown",inputIdTransform:function(a){return a+"_flexselect"},inputNameTransform:function(){},dropdownIdTransform:function(a){return a+"_flexselect_dropdown"}},select:null,input:null,hidden:null,dropdown:null,dropdownList:null,cache:[],results:[],lastAbbreviation:null,abbreviationBeforeFocus:null,selectedIndex:0,picked:false, dropdownMouseover:false,init:function(a,b){c.extend(this.settings,b);this.select=c(a);this.preloadCache();this.renderControls();this.wire()},preloadCache:function(){this.cache=this.select.children("option").map(function(){return{name:c.trim(c(this).text()),value:c(this).val(),score:0}})},renderControls:function(){var a=this.select.children("option:selected");this.hidden=c("<input type='hidden'/>").attr({id:this.select.attr("id"),name:this.select.attr("name")}).val(a.val());this.input=c("<input type='text' autocomplete='off' />").attr({id:this.settings.inputIdTransform(this.select.attr("id")), name:this.settings.inputNameTransform(this.select.attr("name")),accesskey:this.select.attr("accesskey"),tabindex:this.select.attr("tabindex"),style:this.select.attr("style")}).addClass(this.select.attr("class")).val(c.trim(a.text()));this.dropdown=c("<div></div>").attr({id:this.settings.dropdownIdTransform(this.select.attr("id"))}).addClass(this.settings.dropdownClass);this.dropdownList=c("<ul></ul>");this.dropdown.append(this.dropdownList);this.select.after(this.input).after(this.hidden).remove(); c("body").append(this.dropdown)},wire:function(){var a=this;this.input.click(function(){a.lastAbbreviation=null;a.focus()});this.input.mouseup(function(b){b.preventDefault()});this.input.focus(function(){a.abbreviationBeforeFocus=a.input.val();a.input.select();a.picked||a.filterResults()});this.input.blur(function(){if(!a.dropdownMouseover){a.hide();a.picked||a.reset()}});this.dropdownList.mouseover(function(b){if(b.target.tagName=="LI"){var d=a.dropdown.find("li");a.markSelected(d.index(c(b.target)))}}); this.dropdownList.mouseleave(function(){a.markSelected(-1)});this.dropdownList.mouseup(function(){a.pickSelected();a.focusAndHide()});this.dropdown.mouseover(function(){a.dropdownMouseover=true});this.dropdown.mouseleave(function(){a.dropdownMouseover=false});this.dropdown.mousedown(function(b){b.preventDefault()});this.input.keyup(function(b){switch(b.keyCode){case 13:b.preventDefault();a.pickSelected();a.focusAndHide();break;case 27:b.preventDefault();a.reset();a.focusAndHide();break;default:a.filterResults(); break}});this.input.keydown(function(b){switch(b.keyCode){case 9:a.pickSelected();a.hide();break;case 33:b.preventDefault();a.markFirst();break;case 34:b.preventDefault();a.markLast();break;case 38:b.preventDefault();a.moveSelected(-1);break;case 40:b.preventDefault();a.moveSelected(1);break;case 13:case 27:b.preventDefault();b.stopPropagation();break}})},filterResults:function(){var a=this.input.val();if(a!=this.lastAbbreviation){var b=[];c.each(this.cache,function(){this.score=LiquidMetal.score(this.name, a);this.score>0&&b.push(this)});this.results=b;this.sortResults();this.renderDropdown();this.markFirst();this.lastAbbreviation=a;this.picked=false}},sortResults:function(){this.results.sort(function(a,b){return b.score-a.score})},renderDropdown:function(){var a=this.dropdown.outerWidth()-this.dropdown.innerWidth(),b=this.input.offset();this.dropdown.css({width:this.input.outerWidth()-a+"px",top:b.top+this.input.outerHeight()+"px",left:b.left+"px"});var d=this.dropdownList.html("");c.each(this.results, function(){d.append(c("<li/>").html(this.name))});this.dropdown.show()},markSelected:function(a){if(!(a>this.results.length)){var b=this.dropdown.find("li");b.removeClass(this.settings.selectedClass);this.selectedIndex=a;a>=0&&c(b[a]).addClass(this.settings.selectedClass)}},pickSelected:function(){var a=this.results[this.selectedIndex];if(a){this.input.val(a.name);this.hidden.val(a.value);this.picked=true}else this.settings.allowMismatch?this.hidden.val(""):this.reset()},hide:function(){this.dropdown.hide(); this.lastAbbreviation=null},moveSelected:function(a){this.markSelected(this.selectedIndex+a)},markFirst:function(){this.markSelected(0)},markLast:function(){this.markSelected(this.results.length-1)},reset:function(){this.input.val(this.abbreviationBeforeFocus)},focus:function(){this.input.focus()},focusAndHide:function(){this.focus();this.hide()}});c.fn.flexselect=function(a){this.each(function(){this.tagName=="SELECT"&&new c.flexselect(this,a)});return this}})(jQuery);